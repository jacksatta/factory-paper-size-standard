<!doctype html>
<html lang='en'><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width, initial-scale=1'/><title>FPSS UI v1.1</title>
<style>:root{--ink:#0f172a;--bg:#f8fafc;--card:#ffffff;--g:#e2e8f0;--g2:#cbd5e1;--pri:#4063a4;--pri2:#5c79b5;--stop:#d9463e}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.container{max-width:1120px;margin:0 auto;padding:40px 28px}.nav{display:flex;align-items:center;gap:10px;background:var(--card);padding:8px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.nav-links{display:flex;gap:6px}.nav a{padding:10px 14px;border-radius:10px;color:#334155;text-decoration:none}.nav a.active{background:#eef2f7;font-weight:700}
.hamburger{width:34px;height:30px;min-width:34px;display:none;align-items:center;justify-content:center;border-radius:10px;border:1px solid var(--g);background:#fff;cursor:pointer}
@media (max-width:900px){.hamburger{display:flex}.nav-links{display:none;flex-direction:column;gap:6px}.nav.show .nav-links{display:flex}}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:24px}.stack>*{margin-top:24px}.stack>*:first-child{margin-top:0}
h1{margin:0 0 6px 0}h2{margin:0 0 8px 0}h3{margin:0 0 6px 0}.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--g);background:#fff;font-size:16px}
.button{border:0;border-radius:12px;padding:12px 16px;background:var(--pri);color:#fff;cursor:pointer;font-weight:700;text-transform:uppercase;letter-spacing:.4px;font-size:13px;transition:filter .15s}
.button[disabled]{background:#94a3b8;color:#e2e8f0;cursor:not-allowed}.ghost{background:#fff;color:var(--pri2);outline:2px solid var(--pri2)}.stopHot{background:var(--stop);color:#fff;outline:none}
.meta{opacity:.75}.progress{height:8px;background:#eef2f7;border-radius:999px;overflow:hidden}.progress>div{height:100%;width:0;background:var(--pri2);transition:width 360ms cubic-bezier(.2,.7,.2,1)}
.grid{display:grid;grid-template-columns:1fr;gap:24px}table{width:100%;border-collapse:separate;border-spacing:0 10px}th{background:#f1f5f9}td,th{padding:12px;border:1px solid var(--g);vertical-align:middle}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;background:#eef2ff;color:#1e3a8a;font-weight:700}.actions{display:flex;gap:14px;justify-content:flex-end;align-items:center}
.link{background:none;border:0;color:var(--pri2);cursor:pointer;text-transform:uppercase;letter-spacing:.4px}.view{display:none}.view.active{display:block}.footer{opacity:.7;font-size:12px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;padding:20px}.modal-overlay.open{display:flex}
.modal{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.18);max-width:720px;width:100%;padding:24px}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.pill{background:#e2e8f0;border-radius:999px;padding:4px 10px;font-size:12px}</style></head>
<body>
<div class='container stack'>
  <nav class='nav' id='topNav'>
    <div class='nav-links'>
      <a href='#/dashboard' data-route>Dashboard</a><a href='#/jobs' data-route>Jobs</a><a href='#/stations' data-route>Stations</a><a href='#/materials' data-route>Materials</a><a href='#/qa' data-route>QA</a>
    </div>
    <div class='row' style='margin-left:auto;gap:8px'><span id='connBadge' class='pill'>Adapter: SIM (Disconnected)</span><button class='button ghost' id='openConn'>Connection</button><button class='hamburger' id='hamburger' aria-label='Menu'>☰</button></div>
  </nav>
  <section id='view-dashboard' class='view active stack'>
    <header class='card'><h1>Factory Paper Size — UI</h1><p class='meta'>v1.1: Modular adapters — Sim, Serial (Web Serial), WebSocket.</p>
      <div class='row'><input class='input' id='jobName' placeholder='Job name (e.g., SCARA-v1 Joint Stack)' style='max-width:520px'><button class='button' id='newJobBtn'>Create</button><button class='button ghost' id='importBtn'>Import .FPJ</button><input type='file' id='fileInput' accept='.fpj,.json' style='display:none'></div>
      <div id='importInfo' class='meta' style='margin-top:6px'></div></header>
    <div class='grid'>
      <div class='card stack'><h2>Simulation</h2><div class='meta' id='simState'>Stopped</div>
        <div class='row'><button class='button' id='runBtn'>Run</button><button class='button ghost' id='stopBtn' disabled>Stop</button><div class='progress' style='flex:1;min-width:200px'><div id='bar'></div></div><span class='meta'>Targets first job</span></div>
      </div>
      <div class='card stack' id='jobsCard'><div class='row' style='justify-content:space-between;align-items:center'><h2>Jobs</h2><input class='input' id='searchJobs' placeholder='Filter jobs…' style='max-width:260px'></div>
        <table class='table' id='jobsTable'><thead><tr><th>Name</th><th>Created</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>
  <section id='view-jobs' class='view stack'><div class='card'><h2>Jobs</h2><table class='table' id='jobsTable2'><thead><tr><th>Name</th><th>Created</th><th>Status</th><th></th></tr></thead><tbody></tbody></table></div></section>
  <section id='view-stations' class='view stack'><div class='card'><h2>Stations</h2><div id='stations'></div></div></section>
  <section id='view-materials' class='view stack'><div class='card stack'><h2>Materials</h2><div class='row'><input class='input' id='matName' placeholder='Name' style='max-width:220px'><input class='input' id='matQty' placeholder='Qty' style='max-width:120px'><button class='button' id='addMat'>Add</button></div>
    <table class='table' id='matTable'><thead><tr><th>Name</th><th>Qty</th><th></th></tr></thead><tbody></tbody></table></div></section>
  <section id='view-qa' class='view stack'><div class='card stack'><h2>QA Checklist</h2><div id='qaList'></div><div><button class='button' id='exportQA'>Export JSON</button></div></div></section>
  <div class='footer'>FPSS UI v1.1 — inline build with modular adapters.</div>
</div>
<div class='modal-overlay' id='modal'><div class='modal'><h3>Edit Job</h3><div style='margin-top:10px'><label>Title</label><input class='input' id='editTitle'></div>
  <div class='grid2' style='margin-top:12px'><div><label>Status</label><select id='editStatus'><option>New</option><option>Imported</option><option>Scheduled</option><option>Running</option><option>Stopped</option><option>Complete</option></select></div>
  <div><label>Energy</label><input class='input' id='editEnergy' placeholder='solar_peak'></div></div>
  <div class='grid2' style='margin-top:12px'><div><label>Material</label><input class='input' id='editMaterial' placeholder='PETG'></div><div><label>QA Max Dev</label><input class='input' id='editQA' placeholder='0.5mm'></div></div>
  <div class='row' style='justify-content:flex-end;margin-top:16px'><button class='link' id='cancelEdit'>Cancel</button><button class='button' id='saveEdit'>Save</button></div></div></div>
<div class='modal-overlay' id='connModal'><div class='modal'><h3>Connection Settings</h3>
  <div class='grid2' style='margin-top:12px'><div><label>Adapter</label><select id='adapterType'><option value='sim'>Sim (Default)</option><option value='serial'>Serial (Web Serial)</option><option value='ws'>WebSocket</option></select></div><div><label>Target</label><input class='input' id='targetName' placeholder='station/Printer-A1'></div></div>
  <div class='grid2' style='margin-top:12px'><div id='serialOpts'><label>Serial Options</label><div class='meta' style='margin-top:6px'>Web Serial requires HTTPS or localhost. Default baud 115200.</div></div><div id='wsOpts' style='display:none'><label>WebSocket URL</label><input class='input' id='wsURL' placeholder='ws://localhost:8765'></div></div>
  <div class='row' style='justify-content:flex-end;margin-top:16px'><button class='link' id='connCancel'>Cancel</button><button class='button' id='connToggle'>Connect</button></div></div></div>
<script>(function(){var routes=['dashboard','jobs','stations','materials','qa'];function setRoute(){var h=(location.hash.replace('#/','')||'dashboard').toLowerCase();for(var i=0;i<routes.length;i++){var r=routes[i],v=document.getElementById('view-'+r);if(v){v.classList.toggle('active',r===h)}}var a=document.querySelectorAll('[data-route]');for(var j=0;j<a.length;j++){var el=a[j];el.classList.toggle('active',el.getAttribute('href')==='#/'+h)}mirrorJobs()}window.addEventListener('hashchange',setRoute);
var nav=document.getElementById('topNav'),hb=document.getElementById('hamburger');if(hb)hb.addEventListener('click',function(){nav.classList.toggle('show')});
function load(k,f){try{var v=JSON.parse(localStorage.getItem(k));return v||f}catch(e){return f}}function save(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
var KJ='fpps_jobs_v1_1',KM='fpps_mat_v1_1',KQ='fpps_qa_v1_1';var jobs=load(KJ,[]),materials=load(KM,[]),qa=load(KQ,[{label:'Visual inspection',done:false},{label:'Dimensional scan',done:false},{label:'Electrical test',done:false},{label:'Motion test',done:false}]);
if(jobs.length===0){jobs=[{name:'SCARA-v1 Joint Stack',created:Date.now()-3600e3,status:'New',energy:'solar_peak',material:'PETG',qa:'0.5mm'},{name:'QA-Bench Calibration',created:Date.now()-1800e3,status:'Scheduled',energy:'grid',material:'N/A',qa:'0.25mm'}]}
var jobName=document.getElementById('jobName'),newJobBtn=document.getElementById('newJobBtn');var importBtn=document.getElementById('importBtn'),fileInput=document.getElementById('fileInput'),importInfo=document.getElementById('importInfo');
var searchJobs=document.getElementById('searchJobs');var simState=document.getElementById('simState'),runBtn=document.getElementById('runBtn'),stopBtn=document.getElementById('stopBtn'),bar=document.getElementById('bar');
var modal=document.getElementById('modal'),editTitle=document.getElementById('editTitle'),editStatus=document.getElementById('editStatus'),editEnergy=document.getElementById('editEnergy'),editMaterial=document.getElementById('editMaterial'),editQA=document.getElementById('editQA');
var cancelEdit=document.getElementById('cancelEdit'),saveEdit=document.getElementById('saveEdit');var connModal=document.getElementById('connModal'),openConn=document.getElementById('openConn'),connCancel=document.getElementById('connCancel'),connToggle=document.getElementById('connToggle'),connBadge=document.getElementById('connBadge');
var adapterType=document.getElementById('adapterType'),serialOpts=document.getElementById('serialOpts'),wsOpts=document.getElementById('wsOpts'),wsURL=document.getElementById('wsURL'),targetName=document.getElementById('targetName');
adapterType.addEventListener('change',function(){var t=adapterType.value;serialOpts.style.display=(t==='serial')?'block':'none';wsOpts.style.display=(t==='ws')?'block':'none'});
function openEdit(i){editingIndex=i;var j=jobs[i];if(!j)return;editTitle.value=j.name;editStatus.value=j.status||'New';editEnergy.value=j.energy||'';editMaterial.value=j.material||'';editQA.value=j.qa||'';modal.classList.add('open')}
function closeEdit(){modal.classList.remove('open');editingIndex=null}
if(cancelEdit)cancelEdit.addEventListener('click',closeEdit);if(saveEdit)saveEdit.addEventListener('click',function(){if(editingIndex==null)return;var j=jobs[editingIndex];if(editTitle.value.trim())j.name=editTitle.value.trim();j.status=editStatus.value;if(editEnergy.value.trim())j.energy=editEnergy.value.trim();if(editMaterial.value.trim())j.material=editMaterial.value.trim();if(editQA.value.trim())j.qa=editQA.value.trim();renderJobs();closeEdit()});if(modal)modal.addEventListener('click',function(e){if(e.target===modal)closeEdit()});
function fmt(ts){return new Date(ts).toLocaleString()}function rowHTML(j,i){return '<td><strong>'+j.name+'</strong><div class="meta" style="font-size:12px">Energy: '+(j.energy||'solar_peak')+' · Material: '+(j.material||'PETG')+' · QA ≤ '+(j.qa||'0.5mm')+'</div></td><td>'+fmt(j.created)+'</td><td><span class="badge">'+j.status+'</span></td><td class="actions"><button class="link" data-edit="'+i+'">Edit</button><button class="link" data-dup="'+i+'">Duplicate</button><button class="link" data-del="'+i+'">Delete</button></td>'}
function renderJobs(){var q=(searchJobs?searchJobs.value:'').toLowerCase();var tbody=document.querySelector('#jobsTable tbody');if(!tbody)return;tbody.innerHTML='';var sorted=jobs.slice().sort(function(a,b){return b.created-a.created});for(var i=0;i<sorted.length;i++){var j=sorted[i];if(q&&j.name.toLowerCase().indexOf(q)===-1)continue;var tr=document.createElement('tr');tr.innerHTML=rowHTML(j,jobs.indexOf(j));tbody.appendChild(tr)}save(KJ,jobs);mirrorJobs()}
function mirrorJobs(){var tb=document.querySelector('#jobsTable2 tbody');if(!tb)return;tb.innerHTML='';var sorted=jobs.slice().sort(function(a,b){return b.created-a.created});for(var i=0;i<sorted.length;i++){var j=sorted[i];var tr=document.createElement('tr');tr.innerHTML=rowHTML(j,jobs.indexOf(j));tb.appendChild(tr)}}
function addJob(payload){var name=payload.name||('Job '+(jobs.length+1));var job={name:name,created:Date.now(),status:payload.status||'New',energy:payload.energy||'solar_peak',material:payload.material||'PETG',qa:payload.qa||'0.5mm'};jobs.push(job);renderJobs()}
if(newJobBtn)newJobBtn.addEventListener('click',function(){var name=(jobName&&jobName.value)?jobName.value.trim():'';addJob({name:name||null});if(jobName)jobName.value='';document.getElementById('jobsCard').scrollIntoView({behavior:'smooth',block:'start'})});
if(importBtn&&fileInput){importBtn.addEventListener('click',function(){fileInput.click()});fileInput.addEventListener('change',function(){var f=fileInput.files&&fileInput.files[0];if(!f){if(importInfo)importInfo.textContent='';return}if(importInfo)importInfo.textContent='Selected: '+f.name+' ('+Math.round(f.size/1024)+' KB)';var r=new FileReader();r.onload=function(){try{var json=JSON.parse(r.result);var nm=json.name||f.name.replace(/\.(fpj|json)$/i,'');addJob({name:nm,status:'Imported',energy:json.energy,material:json.material,qa:json.qa});if(importInfo)importInfo.textContent+=' — parsed ✓'}catch(e){if(importInfo)importInfo.textContent+=' — parse error'}fileInput.value=''};r.readAsText(f)});}
if(searchJobs)searchJobs.addEventListener('input',renderJobs);
document.addEventListener('click',function(e){var t=e.target;var ed=t.closest?t.closest('[data-edit]'):null;var du=t.closest?t.closest('[data-dup]'):null;var de=t.closest?t.closest('[data-del]'):null;var st1=t.closest?t.closest('[data-st-start]'):null;var st2=t.closest?t.closest('[data-st-stop]'):null;var mplus=t.closest?t.closest('[data-mplus]'):null;var mminus=t.closest?t.closest('[data-mminus]'):null;var mdel=t.closest?t.closest('[data-mdel]'):null;if(ed){openEdit(parseInt(ed.getAttribute('data-edit'),10))}
if(du){var i=parseInt(du.getAttribute('data-dup'),10);var base=jobs[i];addJob({name:base.name+' (copy)',status:base.status,energy:base.energy,material:base.material,qa:base.qa})}
if(de){var i2=parseInt(de.getAttribute('data-del'),10);jobs.splice(i2,1);renderJobs()}if(st1){stations[parseInt(st1.getAttribute('data-st-start'),10)].status='Running';renderStations()}
if(st2){stations[parseInt(st2.getAttribute('data-st-stop'),10)].status='Stopped';renderStations()}if(mplus){materials[parseInt(mplus.getAttribute('data-mplus'),10)].qty++;renderMaterials()}
if(mminus){var i3=parseInt(mminus.getAttribute('data-mminus'),10);materials[i3].qty=Math.max(0,materials[i3].qty-1);renderMaterials()}if(mdel){materials.splice(parseInt(mdel.getAttribute('data-mdel'),10),1);renderMaterials()}});
var timer=null,prog=0;function setRunUI(r){runBtn.disabled=r;stopBtn.disabled=!r;stopBtn.classList.toggle('stopHot',r)}
function startSim(){if(timer)return;sendCommand((targetName.value||'station/Printer-A1'),'start',{});if(jobs.length){jobs[0].status='Running';renderJobs()}setRunUI(true);simState.textContent='Running…';prog=0;bar.style.width='0%';timer=setInterval(function(){prog=Math.min(100,prog+Math.random()*8+4);bar.style.width=prog+'%';if(prog>=100){completeSim()}},360)}
function completeSim(){clearInterval(timer);timer=null;setRunUI(false);simState.textContent='Complete';sendCommand((targetName.value||'station/Printer-A1'),'complete',{});if(jobs.length){jobs[0].status='Complete';renderJobs()}}
function stopSim(){if(!timer)return;clearInterval(timer);timer=null;setRunUI(false);simState.textContent='Stopped';sendCommand((targetName.value||'station/Printer-A1'),'stop',{});if(jobs.length){jobs[0].status='Stopped';renderJobs()}}
if(runBtn)runBtn.addEventListener('click',startSim);if(stopBtn)stopBtn.addEventListener('click',stopSim);
var stations=[{name:'Printer-A1',status:'Idle'},{name:'CNC-A1',status:'Idle'},{name:'Arm-A1',status:'Idle'},{name:'QA-Scan-A1',status:'Idle'}];var stationsEl=document.getElementById('stations');
function renderStations(){if(!stationsEl)return;stationsEl.innerHTML='';for(var i=0;i<stations.length;i++){var s=stations[i];var row=document.createElement('div');row.className='card';row.style.marginBottom='12px';row.innerHTML='<div class="row" style="justify-content:space-between"><div><strong>'+s.name+'</strong><div class="meta" style="font-size:12px">Status: '+s.status+'</div></div><div class="actions"><button class="link" data-st-start="'+i+'">Start</button><span class="meta">/</span><button class="link" data-st-stop="'+i+'">Stop</button></div></div>';stationsEl.appendChild(row)}}
var matBody=document.querySelector('#matTable tbody');var addMat=document.getElementById('addMat');function renderMaterials(){if(!matBody)return;matBody.innerHTML='';for(var i=0;i<materials.length;i++){var m=materials[i];var tr=document.createElement('tr');tr.innerHTML='<td>'+m.name+'</td><td>'+m.qty+'</td><td class="actions"><button class="link" data-mplus="'+i+'">+1</button><button class="link" data-mminus="'+i+'">-1</button><button class="link" data-mdel="'+i+'">Delete</button></td>';matBody.appendChild(tr)}save(KM,materials)}
if(addMat)addMat.addEventListener('click',function(){var n=document.getElementById('matName').value.trim();var q=parseInt(document.getElementById('matQty').value||'0',10);if(!n){alert('Enter material name');return}materials.push({name:n,qty:isNaN(q)?0:q});document.getElementById('matName').value='';document.getElementById('matQty').value='';renderMaterials()});
var qaList=document.getElementById('qaList');var exportQA=document.getElementById('exportQA');function renderQA(){if(!qaList)return;qaList.innerHTML='';for(var i=0;i<qa.length;i++){var it=qa[i];var row=document.createElement('div');row.className='row';row.style.justifyContent='flex-start';row.innerHTML='<input type="checkbox" '+(it.done?'checked':'')+' data-qa="'+i+'"><span>'+it.label+'</span>';qaList.appendChild(row)}save(KQ,qa)}
if(qaList)qaList.addEventListener('change',function(e){var idx=e.target.getAttribute('data-qa');if(idx==null)return;qa[idx].done=!!e.target.checked;renderQA()});if(exportQA)exportQA.addEventListener('click',function(){var blob=new Blob([JSON.stringify(qa,null,2)],{type:'application/json'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='qa_checklist.json';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)});
var currentAdapter=null,currentType='sim',isConnected=false;function setBadge(){connBadge.textContent='Adapter: '+currentType.toUpperCase()+' '+(isConnected?'(Connected)':'(Disconnected)')}
var simAdapter={connect:async function(c){isConnected=true;setBadge();return{ok:true}},sendCommand:async function(t,c,p){console.log('[SIM]',t,c,p);return{ok:true}},getStatus:async function(){return{ts:Date.now(),stations:[]}},disconnect:async function(){isConnected=false;setBadge();return{ok:true}}};
var serialAdapter={port:null,writer:null,reader:null,connect:async function(cfg){if(!('serial' in navigator)){alert('Web Serial not supported. Use Chrome on HTTPS/localhost.');return{ok:false}};this.port=await navigator.serial.requestPort();await this.port.open({baudRate:115200});this.writer=this.port.writable.getWriter();isConnected=true;setBadge();return{ok:true}},sendCommand:async function(t,c,p){if(!this.writer)return{ok:false};var msg=JSON.stringify({target:t,command:c,params:p})+'\n';await this.writer.write(new TextEncoder().encode(msg));return{ok:true}},getStatus:async function(){return{ok:true}},disconnect:async function(){try{if(this.writer){this.writer.releaseLock()}if(this.port){await this.port.close()}}catch(e){}this.port=this.writer=this.reader=null;isConnected=false;setBadge();return{ok:true}}};
var wsAdapter={ws:null,connect:async function(cfg){try{this.ws=new WebSocket(cfg.wsURL||'ws://localhost:8765');this.ws.onopen=function(){isConnected=true;setBadge()};this.ws.onclose=function(){isConnected=false;setBadge()};return{ok:true}}catch(e){alert('WS connect failed');return{ok:false}}},sendCommand:async function(t,c,p){if(!this.ws||this.ws.readyState!==1)return{ok:false};this.ws.send(JSON.stringify({target:t,command:c,params:p}));return{ok:true}},getStatus:async function(){return{ok:true}},disconnect:async function(){if(this.ws){this.ws.close();this.ws=null}isConnected=false;setBadge();return{ok:true}}};
function pickAdapter(type){currentType=type||'sim';currentAdapter=(currentType==='serial')?serialAdapter:(currentType==='ws')?wsAdapter:simAdapter;setBadge()}
pickAdapter('sim');async function connectAdapter(){var t=adapterType.value;pickAdapter(t);var cfg={wsURL:wsURL.value};await currentAdapter.connect(cfg)}async function disconnectAdapter(){if(currentAdapter)await currentAdapter.disconnect()}
async function sendCommand(target,command,params){if(!currentAdapter)pickAdapter('sim');return currentAdapter.sendCommand(target,command,params||{})}
var connModal=document.getElementById('connModal');openConn.addEventListener('click',function(){connModal.classList.add('open')});var connCancel=document.getElementById('connCancel');connCancel.addEventListener('click',function(){connModal.classList.remove('open')});connModal.addEventListener('click',function(e){if(e.target===connModal)connModal.classList.remove('open')});var connToggle=document.getElementById('connToggle');var targetName=document.getElementById('targetName');var wsURL=document.getElementById('wsURL');var adapterType=document.getElementById('adapterType');
connToggle.addEventListener('click',async function(){if(!isConnected){await connectAdapter()}else{await disconnectAdapter()}connModal.classList.remove('open')});
function renderStationsWrapper(){renderStations()}renderJobs();renderStationsWrapper();renderMaterials();renderQA();setRoute();setBadge();})();</script></body></html>